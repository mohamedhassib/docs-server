{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v5.json", "dbt_version": "1.7.4", "generated_at": "2024-02-12T13:17:11.029284Z", "invocation_id": "cb73f350-6e15-4628-b6f2-4a62198b2b10", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2024-02-12T13:17:10.871033Z", "completed_at": "2024-02-12T13:17:10.900726Z"}, {"name": "execute", "started_at": "2024-02-12T13:17:10.901303Z", "completed_at": "2024-02-12T13:17:10.901310Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.03159809112548828, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.dealers_activity.dealers_segmentation", "compiled": true, "compiled_code": "\nWITH  __dbt__cte__stg_dealers as (\n\n\nWITH `dealer_first_visit` AS (\n    SELECT\n        `users`.`id` AS `dealer_id`,\n        MIN(`ajans_sessions`.`event_date`) AS `dealer_first_app_visit`\n    FROM `pricing-338819`.`ajans_db`.`users` AS `users`\n    INNER JOIN `pricing-338819`.`mixpanel_processed`.`ajans_mp_users` AS `ajans_mp_users`\n        ON\n            LTRIM(\n        REGEXP_REPLACE(users.phone, r'\\+2|[^0-9|,]', ''),\n        '0'\n    )\n            = LTRIM(\n        REGEXP_REPLACE(ajans_mp_users.mobile_number, r'\\+2|[^0-9|,]', ''),\n        '0'\n    )\n    INNER JOIN\n        `pricing-338819`.`mixpanel_processed`.`ajans_sessions` AS `ajans_sessions`\n        ON `ajans_sessions`.`mp_user_id` IN UNNEST(`ajans_mp_users`.`mp_user_id`)\n    GROUP BY `users`.`id`\n),\n\n`dealer_first_transaction` AS (\n    SELECT\n        `users`.`id` AS `dealer_id`,\n        MIN(CASE\n            WHEN `opportunity`.`opportunity_current_status` IN (\n                \"Documents Review\", \"Customer Handover\", \"Sold\"\n            ) THEN `opportunity`.`opportunity_contract_status_datetime`\n        END)\n            AS `dealer_first_trasaction`\n    FROM `pricing-338819`.`ajans_db`.`users` AS `users`\n    LEFT JOIN\n        `pricing-338819`.`reporting`.`wholesale_selling_opportunity` AS `opportunity`\n        ON `users`.`sf_dealer_id` = `opportunity`.`account_id`\n    WHERE `opportunity`.`opportunity_contract_status_datetime` IS NOT NULL\n    GROUP BY `users`.`id`\n),\n\n`dealer_activation` AS (\n    SELECT\n        `users`.`id` AS `dealer_id`,\n        MIN(`register_applications`.`created_at`) AS `activated_at`\n    FROM `pricing-338819`.`ajans_db`.`register_applications` AS `register_applications`\n    INNER JOIN `pricing-338819`.`ajans_db`.`users` AS `users` USING (`phone`)\n    WHERE `register_applications`.`status` = \"activated\"\n    GROUP BY `users`.`id`\n)\n\nSELECT\n    `users`.`id` AS `dealer_id`,\n    `users`.`sf_dealer_id` AS `sf_dealer_id`,\n    `users`.`name` AS `dealer_name`,\n    `users`.`phone` AS `dealer_phone`,\n    `users`.`created_at` AS `dealer_created_at`,\n    `users`.`email` AS `dealer_email`,\n    `sf_account`.`Area__c` AS `area`,\n    `sf_account`.`City__c` AS `city`,\n    `users`.`first_bid` AS `dealer_first_bid`,\n    `dealers_contacts`.`dealer_type`,\n    `dealer_first_visit`.`dealer_first_app_visit`,\n    COALESCE(\n        `dealer_activation`.`activated_at`,\n        CASE WHEN `users`.`active` THEN `users`.`created_at` END\n    ) AS `activated_at`,\n    `dealer_first_transaction`.`dealer_first_trasaction`\nFROM `pricing-338819`.`ajans_db`.`users` AS `users`\nLEFT JOIN `dealer_first_visit` ON `users`.`id` = `dealer_first_visit`.`dealer_id`\nLEFT JOIN `dealer_first_transaction`\n    ON `users`.`id` = `dealer_first_transaction`.`dealer_id`\nLEFT JOIN `dealer_activation`\n    ON `users`.`id` = `dealer_activation`.`dealer_id`\nLEFT JOIN\n    `pricing-338819`.`ajans_db`.`dealers_contacts` AS `dealers_contacts`\n    ON `users`.`dealer_contact_id` = `dealers_contacts`.`id`\nLEFT JOIN\n    `pricing-338819`.`ajans_db`.`dealer_ships` AS `dealer_ships`\n    ON `dealers_contacts`.`dealer_id` = `dealer_ships`.`id`\nLEFT JOIN\n    `pricing-338819`.`salesforce`.`Account` AS `sf_account`\n    ON `users`.`sf_dealer_id` = `sf_account`.`Id`\nLEFT JOIN `pricing-338819`.`ajans_db`.`users_roles` AS `users_roles`\n    ON `users`.`id` = `users_roles`.`user_id`\nLEFT JOIN `pricing-338819`.`ajans_db`.`roles` AS `roles`\n    ON `users_roles`.`role_id` = `roles`.`id`\n), `dates` AS (\n    SELECT `date_array` AS `date_key`\n    FROM\n        UNNEST(GENERATE_DATE_ARRAY(\"2022-10-01\", CURRENT_DATE(), INTERVAL 1 MONTH))\n            AS `date_array`\n    \n        WHERE `date_array` >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 MONTH)\n    \n),\n\n`dealer_monthly_activity` AS (\n    SELECT\n        `dealer`.`dealer_id`,\n        `dates`.`date_key` AS `month_date`,\n        `dealer`.`dealer_first_app_visit`,\n        `dealer`.`dealer_first_trasaction`,\n        `dealer`.`activated_at`,\n        COUNT(\n            DISTINCT\n            CASE\n                WHEN\n                    `opportunity`.`opportunity_current_status` IN\n                    (\n                        \"Documents Review\",\n                        \"Customer Handover\",\n                        \"Sold\"\n                    )\n                    THEN\n                        `opportunity`.`opportunity_id`\n            END\n        ) AS `sales_count`\n    FROM\n        __dbt__cte__stg_dealers AS `dealer`\n    CROSS JOIN\n        `dates` AS `dates`\n    LEFT JOIN\n        `pricing-338819`.`reporting`.`wholesale_selling_opportunity` AS `opportunity`\n        ON\n            `dealer`.`sf_dealer_id` = `opportunity`.`account_id`\n            AND DATE(\n                DATE_TRUNC(\n                    `opportunity`.`opportunity_customer_handover_status_datetime`, MONTH\n                )\n            )\n            = `dates`.`date_key`\n    GROUP BY\n        `dealer`.`dealer_id`,\n        `dates`.`date_key`,\n        `dealer`.`dealer_first_app_visit`,\n        `dealer`.`dealer_first_trasaction`,\n        `dealer`.`activated_at`\n),\n\n`dealer_sales` AS (\n    SELECT\n        `dealer_activity`.`dealer_id`,\n        `dealer_activity`.`month_date`,\n        `dealer_activity`.`dealer_first_app_visit`,\n        DATE(DATE_TRUNC(`dealer_activity`.`dealer_first_app_visit`, MONTH))\n            AS `dealer_first_app_visit_month`,\n        `dealer_activity`.`dealer_first_trasaction`,\n        DATE(DATE_TRUNC(`dealer_activity`.`dealer_first_trasaction`, MONTH))\n            AS `dealer_first_transaction_month`,\n        `dealer_activity`.`sales_count` AS `current_month_sales`,\n        COALESCE(LAG(`dealer_activity`.`sales_count`, 1) OVER (\n            PARTITION BY `dealer_activity`.`dealer_id`\n            ORDER BY\n                `dealer_activity`.`month_date`\n        ), 0) AS `previous_month_sales`\n    FROM\n        `dealer_monthly_activity` AS `dealer_activity`\n\n)\n\nSELECT\n    `dealer_id`,\n    `month_date`,\n    `dealer_first_app_visit`,\n    `dealer_first_app_visit_month`,\n    `dealer_first_trasaction`,\n    `dealer_first_transaction_month`,\n    `current_month_sales`,\n    `previous_month_sales`,\n    CASE\n        WHEN\n            `month_date` = `dealer_first_transaction_month`\n            THEN\n                \"New Dealer\"\n        WHEN\n            `month_date` >= `dealer_first_app_visit_month`\n            AND `month_date`\n            < COALESCE(`dealer_first_transaction_month`, DATE(\"2999-09-01\"))\n            THEN\n                \"Acquired Dealer\"\n        WHEN\n            DATE_DIFF(`month_date`, `dealer_first_transaction_month`, MONTH) = 1\n            AND `current_month_sales` > 0\n            THEN\n                \"Retained New Dealer\"\n        WHEN\n            `current_month_sales` > 0\n            AND `previous_month_sales` > 0\n            THEN\n                \"Retained Returned Dealer\"\n        WHEN\n            `current_month_sales` = 0\n            THEN\n                \"Churned Dealer\"\n        WHEN\n            `current_month_sales` > 0\n            AND `previous_month_sales` = 0\n            THEN\n                \"Reactivated Dealer\"\n    END\n        AS `dealer_segment`\nFROM\n    `dealer_sales`\nWHERE\n    `month_date` >= `dealer_first_app_visit_month`\n    OR `month_date` >= `dealer_first_transaction_month`", "relation_name": "`pricing-338819`.`dealers_activity`.`dealers_segmentation`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-02-12T13:17:10.903094Z", "completed_at": "2024-02-12T13:17:10.935784Z"}, {"name": "execute", "started_at": "2024-02-12T13:17:10.936270Z", "completed_at": "2024-02-12T13:17:10.936276Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.034214019775390625, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.dealers_activity.dealers_requests", "compiled": true, "compiled_code": "\n\nWITH  __dbt__cte__stg_opportunity_request as (\n\n\nWITH `opportunity_request` AS (\n    SELECT DISTINCT\n        `auction_requests`.`id` AS `request_id`,\n        `opportunity`.`opportunity_id` AS `opportunity_id`,\n        `opportunity`.`opportunity_current_status` AS `opportunity_stage_name`,\n        `opportunity`.`opportunity_creation_datetime`,\n        `opportunity`.`opportunity_close_date`,\n        `opportunity`.`opportunity_log_payment_status_datetime`,\n        `opportunity`.`opportunity_payment_status_datetime`,\n        `opportunity`.`opportunity_contract_status_datetime`,\n        `opportunity`.`opportunity_customer_handover_status_datetime`,\n        `opportunity`.`opportunity_sold_status_datetime`,\n        `opportunity`.`opportunity_returned_status_datetime`,\n        `opportunity`.`is_sold` AS `opportunity_is_sold`,\n        `opportunity`.`is_returned` AS `opportunity_is_returned`,\n        `opportunity`.`is_tbi` AS `opportunity_is_tbi`,\n        `opportunity`.`is_tbi_in_progress` AS `opportunity_is_tbi_in_progress`,\n        `opportunity`.`is_delivered` AS `opportunity_is_delivered`,\n        ROW_NUMBER()\n            OVER (\n                PARTITION BY `opportunity`.`opportunity_id`\n                ORDER BY\n                    DATE_DIFF(\n                        `opportunity`.`opportunity_creation_datetime`,\n                        `auction_requests`.`created_at`,\n                        SECOND\n                    ) ASC\n            )\n            AS `recency_rank`\n    FROM\n        `pricing-338819`.`ajans_db`.`auction_requests` AS `auction_requests`\n    INNER JOIN\n        `pricing-338819`.`ajans_db`.`users` AS `users`\n        ON\n            `auction_requests`.`dealer_id` = `users`.`id`\n    INNER JOIN\n        `pricing-338819`.`ajans_db`.`vehicle_auctions` AS `vehicle_auctions`\n        ON\n            `auction_requests`.`auction_id` = `vehicle_auctions`.`id`\n    INNER JOIN\n        `pricing-338819`.`ajans_db`.`vehicles` AS `vehicles`\n        ON\n            `vehicle_auctions`.`vehicle_id` = `vehicles`.`id`\n    INNER JOIN\n        `pricing-338819`.`salesforce`.`Car__c` AS `car`\n        ON\n            `vehicles`.`sf_vehicle_id` = `car`.`id`\n    INNER JOIN\n        `pricing-338819`.`reporting`.`wholesale_selling_opportunity` AS `opportunity`\n        ON\n            `users`.`sf_dealer_id` = `opportunity`.`account_id`\n            AND `car`.`Id` = `opportunity`.`car_id`\n    WHERE\n        DATE_DIFF(\n            `opportunity`.`opportunity_creation_datetime`,\n            `auction_requests`.`created_at`,\n            SECOND\n        )\n        >= 0\n        AND `auction_requests`.`type` = 'Buy Now'\n)\n\nSELECT *\nFROM `opportunity_request`\nWHERE `recency_rank` = 1\n), `users` AS (\n    SELECT\n        `id`,\n        `name`,\n        `phone`\n    FROM `pricing-338819`.`ajans_db`.`users` AS `users`\n),\n\n`inner_logs` AS (\n    SELECT\n        `auction_request_logs`.`auction_request_id`,\n        `auction_request_logs`.`auction_request_status`,\n        `auction_request_logs`.`created_at`,\n        `users`.`name`,\n        ROW_NUMBER()\n            OVER (\n                PARTITION BY\n                    `auction_request_logs`.`auction_request_id`\n                ORDER BY `auction_request_logs`.`created_at`\n            ) AS `rn`\n    FROM\n        `pricing-338819`.`ajans_db`.`auction_request_logs` AS `auction_request_logs`\n    INNER JOIN `users`\n        ON\n            `auction_request_logs`.`user_id` = `users`.`id`\n    \n        WHERE\n            DATE(`auction_request_logs`.`created_at`)\n            >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n    \n),\n\n`auction_request_user_history` AS (\n    SELECT\n        `auction_request_id`,\n        `Contacted` AS `contacted_user`,\n        `Received` AS `received_user`,\n        `Failed After Visit` AS `failed_after_visit_user`, -- noqa: RF05\n        `Failed Before Visit` AS `failed_before_visit_user`, -- noqa: RF05\n        `Visited` AS `visited_user`,\n        `Succeeded` AS `succeeded_user`\n    FROM (\n        SELECT\n            `inner_logs`.`auction_request_id`,\n            `inner_logs`.`auction_request_status`,\n            `inner_logs`.`name`\n        FROM `inner_logs`\n        WHERE\n            `rn` = 1\n    ) PIVOT (ANY_VALUE(\n        `name`) FOR `auction_request_status` IN (\n        \"Contacted\",\n        \"Received\",\n        \"Failed After Visit\",\n        \"Failed Before Visit\",\n        \"Visited\",\n        \"Succeeded\"\n    ))\n),\n\n\n`current_status` AS (\n    SELECT\n        `auction_request_id`,\n        `auction_request_status`\n    FROM (\n        SELECT\n            `inner_logs`.`auction_request_id`,\n            `inner_logs`.`auction_request_status`\n        FROM `inner_logs`\n        WHERE\n            `rn` = 1\n    )\n),\n\n\n`current_status_2` AS (\n    SELECT\n        `auction_request_id`,\n        `status` AS `auction_request_status`\n    FROM `pricing-338819`.`ajans_db`.`auction_request_details`\n    \n        WHERE\n            COALESCE(DATE(`updated_at`), DATE(`created_at`))\n            >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n    \n),\n\n`comments` AS (\n    SELECT\n        `auction_request_id`,\n        `auction_request_status`,\n        `comment`\n    FROM `pricing-338819`.`ajans_db`.`auction_request_comments`\n    \n        WHERE\n            COALESCE(DATE(`updated_at`), DATE(`created_at`))\n            >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n    \n),\n\n`auction_request_history` AS (\n    SELECT\n        `auction_request_id`,\n        `Contacted` AS `contacted_at`,\n        `Received` AS `received_at`,\n        `Failed After Visit` AS `failed_after_visit_at`, -- noqa: RF05\n        `Failed Before Visit` AS `failed_before_visit_at`, -- noqa: RF05\n        `Visited` AS `visited_at`,\n        `Succeeded` AS `succeeded_at`\n    FROM (\n        SELECT\n            `auction_request_id`,\n            `auction_request_status`,\n            `created_at`\n        FROM\n            `pricing-338819`.`ajans_db`.`auction_request_logs`\n        \n            WHERE\n                COALESCE(DATE(`updated_at`), DATE(`created_at`))\n                >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n        \n    ) PIVOT (MIN(`created_at`) FOR `auction_request_status` IN (\n        \"Contacted\",\n        \"Received\",\n        \"Failed After Visit\",\n        \"Failed Before Visit\",\n        \"Visited\",\n        \"Succeeded\"\n    ))\n)\n\n\nSELECT\n    `auction_requests`.`id` AS `auction_request_id`,\n    `auction_requests`.`dealer_id`,\n    `users`.`phone` AS `dealer_phone`,\n    `auction_requests`.`created_at` AS `auction_request_created_at`,\n    `auction_requests`.`type` AS `request_type`,\n    `auction_request_history`.`contacted_at`,\n    `auction_request_user_history`.`contacted_user`,\n    `auction_request_history`.`received_at`,\n    `auction_request_user_history`.`received_user`,\n    `auction_request_history`.`failed_after_visit_at`,\n    `auction_request_user_history`.`failed_after_visit_user`,\n    `auction_request_history`.`failed_before_visit_at`,\n    `auction_request_user_history`.`failed_before_visit_user`,\n    `auction_request_history`.`visited_at`,\n    `auction_request_user_history`.`visited_user`,\n    `auction_request_history`.`succeeded_at`,\n    `sf_car`.`Name` AS `car_name`,\n    `vehicles`.`id` AS `vehicle_id`,\n    `vehicles`.`make` AS `car_make`,\n    `vehicles`.`model` AS `car_model`,\n    `vehicles`.`year` AS `car_year`,\n    `vehicles`.`kilometrage` AS `car_kilometrage`,\n    SAFE_CAST(`sf_car`.`Sylndr_Offer_Price_0__c` AS FLOAT64) AS `sylndr_offer_price`,\n    SAFE_CAST(`rp`.`median_asking_price` AS FLOAT64) AS `median_asking_price`,\n    SAFE_CAST(`rp`.`gross_selling_price` AS FLOAT64) AS `gross_selling_price`,\n    COALESCE(\n        `current_status_2`.`auction_request_status`,\n        `comments`.`auction_request_status`,\n        `current_status`.`auction_request_status`\n    ) AS `request_status`,\n    `comments`.`comment` AS `request_comment`,\n    `sf_car`.`Category__c` AS `acquisition_source`,\n    `opportunity`.`opportunity_id`,\n    `opportunity`.`opportunity_stage_name`,\n    `opportunity`.`opportunity_creation_datetime`,\n    `opportunity`.`opportunity_close_date`\nFROM `pricing-338819`.`ajans_db`.`auction_requests` AS `auction_requests`\nLEFT JOIN `users`\n    ON `users`.`id` = `auction_requests`.`dealer_id`\nLEFT JOIN\n    `pricing-338819`.`ajans_db`.`vehicle_auctions` AS `vehicle_auctions`\n    ON `auction_requests`.`auction_id` = `vehicle_auctions`.`id`\nLEFT JOIN\n    `pricing-338819`.`ajans_db`.`vehicles` AS `vehicles`\n    ON `vehicle_auctions`.`vehicle_id` = `vehicles`.`id`\nLEFT JOIN\n    `pricing-338819`.`salesforce`.`Car__c` AS `sf_car`\n    ON `vehicles`.`sf_vehicle_id` = `sf_car`.`id`\nLEFT JOIN\n    `pricing-338819`.`google_sheets`.`retail_pricing` AS `rp`\n    ON `vehicles`.`sf_vehicle_name` = `rp`.`car_name`\nLEFT JOIN\n    __dbt__cte__stg_opportunity_request AS `opportunity`\n    ON\n        `auction_requests`.`id` = `opportunity`.`request_id`\nLEFT JOIN\n    `current_status` AS `current_status`\n    ON\n        `auction_requests`.`id` = `current_status`.`auction_request_id`\nLEFT JOIN\n    `auction_request_history` AS `auction_request_history`\n    ON\n        `auction_requests`.`id` = `auction_request_history`.`auction_request_id`\nLEFT JOIN\n    `auction_request_user_history` AS `auction_request_user_history`\n    ON\n        `auction_requests`.`id` = `auction_request_user_history`.`auction_request_id`\nLEFT JOIN\n    `current_status_2` AS `current_status_2`\n    ON\n        `auction_requests`.`id` = `current_status_2`.`auction_request_id`\nLEFT JOIN\n    `comments` AS `comments`\n    ON\n        `auction_requests`.`id` = `comments`.`auction_request_id`", "relation_name": "`pricing-338819`.`dealers_activity`.`dealers_requests`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-02-12T13:17:10.937792Z", "completed_at": "2024-02-12T13:17:10.974323Z"}, {"name": "execute", "started_at": "2024-02-12T13:17:10.974810Z", "completed_at": "2024-02-12T13:17:10.974815Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.03803610801696777, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.dealers_activity.vehicle_activity", "compiled": true, "compiled_code": "\nWITH  __dbt__cte__stg_opportunity_request as (\n\n\nWITH `opportunity_request` AS (\n    SELECT DISTINCT\n        `auction_requests`.`id` AS `request_id`,\n        `opportunity`.`opportunity_id` AS `opportunity_id`,\n        `opportunity`.`opportunity_current_status` AS `opportunity_stage_name`,\n        `opportunity`.`opportunity_creation_datetime`,\n        `opportunity`.`opportunity_close_date`,\n        `opportunity`.`opportunity_log_payment_status_datetime`,\n        `opportunity`.`opportunity_payment_status_datetime`,\n        `opportunity`.`opportunity_contract_status_datetime`,\n        `opportunity`.`opportunity_customer_handover_status_datetime`,\n        `opportunity`.`opportunity_sold_status_datetime`,\n        `opportunity`.`opportunity_returned_status_datetime`,\n        `opportunity`.`is_sold` AS `opportunity_is_sold`,\n        `opportunity`.`is_returned` AS `opportunity_is_returned`,\n        `opportunity`.`is_tbi` AS `opportunity_is_tbi`,\n        `opportunity`.`is_tbi_in_progress` AS `opportunity_is_tbi_in_progress`,\n        `opportunity`.`is_delivered` AS `opportunity_is_delivered`,\n        ROW_NUMBER()\n            OVER (\n                PARTITION BY `opportunity`.`opportunity_id`\n                ORDER BY\n                    DATE_DIFF(\n                        `opportunity`.`opportunity_creation_datetime`,\n                        `auction_requests`.`created_at`,\n                        SECOND\n                    ) ASC\n            )\n            AS `recency_rank`\n    FROM\n        `pricing-338819`.`ajans_db`.`auction_requests` AS `auction_requests`\n    INNER JOIN\n        `pricing-338819`.`ajans_db`.`users` AS `users`\n        ON\n            `auction_requests`.`dealer_id` = `users`.`id`\n    INNER JOIN\n        `pricing-338819`.`ajans_db`.`vehicle_auctions` AS `vehicle_auctions`\n        ON\n            `auction_requests`.`auction_id` = `vehicle_auctions`.`id`\n    INNER JOIN\n        `pricing-338819`.`ajans_db`.`vehicles` AS `vehicles`\n        ON\n            `vehicle_auctions`.`vehicle_id` = `vehicles`.`id`\n    INNER JOIN\n        `pricing-338819`.`salesforce`.`Car__c` AS `car`\n        ON\n            `vehicles`.`sf_vehicle_id` = `car`.`id`\n    INNER JOIN\n        `pricing-338819`.`reporting`.`wholesale_selling_opportunity` AS `opportunity`\n        ON\n            `users`.`sf_dealer_id` = `opportunity`.`account_id`\n            AND `car`.`Id` = `opportunity`.`car_id`\n    WHERE\n        DATE_DIFF(\n            `opportunity`.`opportunity_creation_datetime`,\n            `auction_requests`.`created_at`,\n            SECOND\n        )\n        >= 0\n        AND `auction_requests`.`type` = 'Buy Now'\n)\n\nSELECT *\nFROM `opportunity_request`\nWHERE `recency_rank` = 1\n), `dates` AS (\n    SELECT `date_array` AS `date_key`\n    FROM\n        UNNEST(\n            GENERATE_DATE_ARRAY(\"2022-10-01\", CURRENT_DATE(), INTERVAL 1 DAY)\n        ) AS `date_array`\n    \n        WHERE `date_array` >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n    \n),\n\n`all_sessions` AS (\n    SELECT\n        `aj_sessions`.`event_date` AS `date_key`,\n        COUNT(DISTINCT `aj_sessions`.`mp_session_id`) AS `all_sessions`\n    FROM `mixpanel_processed.ajans_sessions` AS `aj_sessions`\n    \n        WHERE\n            DATE(`aj_sessions`.`event_date`)\n            >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n    \n    GROUP BY `aj_sessions`.`event_date`\n),\n\n`vehicle_requests` AS (\n    SELECT\n        `aj_vehicle`.`id` AS `vehicle_id`,\n        `aj_vehicle`.`sf_vehicle_id`,\n        `d`.`date_key`,\n        COUNT(DISTINCT `ar`.`id`) AS `opened_requests`,\n        COUNT(\n            DISTINCT CASE\n                WHEN `arl`.`auction_request_status` = \"Succeeded\" THEN `ar`.`id`\n            END\n        ) AS `successful_requests`,\n        COUNT(DISTINCT `ro`.`opportunity_id`) AS `opened_salesforce_opportunities`,\n        COUNT(\n            DISTINCT CASE\n                WHEN `ro`.`opportunity_stage_name` = \"Sold\" THEN `ro`.`opportunity_id`\n            END\n        ) AS `successful_salesforce_opportunities`\n    FROM `pricing-338819`.`ajans_db`.`vehicles` AS `aj_vehicle`\n    CROSS JOIN `dates` AS `d`\n    LEFT JOIN\n        `pricing-338819`.`ajans_db`.`vehicle_auctions` AS `vehicle_auction`\n        ON\n            `aj_vehicle`.`id` = `vehicle_auction`.`vehicle_id`\n            AND `d`.`date_key` = DATE(`vehicle_auction`.`created_at`)\n    LEFT JOIN\n        `pricing-338819`.`ajans_db`.`auction_requests` AS `ar`\n        ON\n            `vehicle_auction`.`id` = `ar`.`auction_id`\n            AND DATE(`ar`.`created_at`) = `d`.`date_key`\n    LEFT JOIN\n        `pricing-338819`.`ajans_db`.`auction_request_logs` AS `arl`\n        ON `ar`.`id` = `arl`.`auction_request_id`\n    LEFT JOIN\n        __dbt__cte__stg_opportunity_request AS `ro`\n        ON `ar`.`id` = `ro`.`request_id`\n    WHERE\n        `d`.`date_key` >= DATE(`aj_vehicle`.`created_at`)\n\n    GROUP BY `aj_vehicle`.`id`, `aj_vehicle`.`sf_vehicle_id`, `d`.`date_key`\n    HAVING `opened_requests` > 0\n),\n\n`vehicle_activity` AS (\n    SELECT\n        `aj_vehicle`.`id` AS `vehicle_id`,\n        `d`.`date_key`,\n        COUNT(DISTINCT `aj_screen_auction_profile`.`mp_event_id`)\n            AS `car_profile_events`,\n        COUNT(DISTINCT `aj_action_interested`.`mp_event_id`) AS `interested_events`,\n        COUNT(DISTINCT `aj_action_buy_now`.`mp_event_id`) AS `buy_now_events`,\n        COUNT(DISTINCT `aj_screen_buy_now_confirmation_popup`.`mp_event_id`)\n            AS `buy_now_confirmation_events`,\n        COUNT(DISTINCT `aj_action_showroom_request`.`event_id`) AS `showroom_events`\n    FROM `pricing-338819`.`ajans_db`.`vehicles` AS `aj_vehicle`\n    CROSS JOIN `dates` AS `d`\n    LEFT JOIN\n        `pricing-338819`.`mixpanel_processed`.`ajans_screen_auction_profile`\n            AS `aj_screen_auction_profile`\n        ON\n            `aj_vehicle`.`id` = `aj_screen_auction_profile`.`vehicle_id`\n            AND `d`.`date_key` = `aj_screen_auction_profile`.`event_date`\n    LEFT JOIN\n        `pricing-338819`.`mixpanel_processed`.`ajans_action_interested`\n            AS `aj_action_interested`\n        ON\n            `aj_vehicle`.`id` = `aj_action_interested`.`vehicle_id`\n            AND `d`.`date_key` = `aj_action_interested`.`event_date`\n    LEFT JOIN\n        `pricing-338819`.`mixpanel_processed`.`ajans_action_buy_now`\n            AS `aj_action_buy_now`\n        ON\n            `aj_vehicle`.`id` = `aj_action_buy_now`.`vehicle_id`\n            AND `d`.`date_key` = `aj_action_buy_now`.`event_date`\n    LEFT JOIN\n        `pricing-338819`.`mixpanel_processed`.`ajans_screen_buy_now_confirmation_popup`\n            AS `aj_screen_buy_now_confirmation_popup`\n        ON\n            `aj_vehicle`.`id` = `aj_screen_buy_now_confirmation_popup`.`vehicle_id`\n            AND `d`.`date_key` = `aj_screen_buy_now_confirmation_popup`.`event_date`\n    LEFT JOIN\n        `pricing-338819`.`mixpanel_processed`.`ajans_action_showroom_request`\n            AS `aj_action_showroom_request`\n        ON\n            `aj_vehicle`.`id` = `aj_action_showroom_request`.`vehicle_id`\n            AND `d`.`date_key` = `aj_action_showroom_request`.`event_date`\n\n    WHERE\n        `d`.`date_key` >= DATE(`aj_vehicle`.`created_at`)\n\n    GROUP BY `aj_vehicle`.`id`, `d`.`date_key`\n    HAVING `car_profile_events` > 0\n)\n\nSELECT\n    `d`.`date_key` AS `event_date`,\n    `aj_vehicle`.`id`,\n    `aj_vehicle`.`make`,\n    `aj_vehicle`.`model`,\n    `aj_vehicle`.`year`,\n    `aj_vehicle`.`kilometrage_type`,\n    `aj_vehicle`.`kilometrage`,\n    `aj_vehicle`.`transmission`,\n    `aj_vehicle`.`images`,\n    `aj_vehicle`.`status`,\n    `aj_vehicle`.`has_valid_license`,\n    `aj_vehicle`.`license_valid_until`,\n    `aj_vehicle`.`count_previous_owners`,\n    `aj_vehicle`.`body_type`,\n    `aj_vehicle`.`created_at`,\n    `aj_vehicle`.`updated_at`,\n    `aj_vehicle`.`sf_vehicle_id`,\n    `aj_vehicle`.`sf_vehicle_name`,\n    `aj_vehicle`.`class`,\n    `aj_vehicle`.`ownership_type`,\n    `aj_vehicle`.`engine_type`,\n    `aj_vehicle`.`fuel_type`,\n    `aj_vehicle`.`traffic_unit`,\n    `aj_vehicle`.`engine_displacement`,\n    `aj_vehicle`.`number_of_cylinders`,\n    `aj_vehicle`.`number_of_keys`,\n    `aj_vehicle`.`service_history_report`,\n    `aj_vehicle`.`maintenance_invoices`,\n    `aj_vehicle`.`summary`,\n    `sf_vehicle`.`ajans_is_published`,\n    `sf_vehicle`.`ajans_published_at`,\n    `sf_vehicle`.`ajans_unpublished_at`,\n    `sf_vehicle`.`car_category`,\n    COALESCE(`sf_vehicle`.`last_allocation_at`, `sf_vehicle`.`acquisition_datetime`)\n        AS `last_allocation_at`,\n    `sf_vehicle`.`last_allocation_from`,\n    COALESCE(`sf_vehicle`.`allocation_category`, `sf_vehicle`.`last_allocation_to`)\n        AS `last_allocation_to`,\n    `sf_vehicle`.`sold_at`,\n    `sf_vehicle`.`acquisition_datetime` AS `acquired_at`,\n    `sf_vehicle`.`is_sold`,\n    `sf_vehicle`.`days_on_hand`,\n    `sf_vehicle`.`current_status`,\n    COALESCE(`all_sessions`.`all_sessions`, 0) AS `all_sessions`,\n    COALESCE(`vehicle_activity`.`car_profile_events`, 0) AS `car_profile_events`,\n    COALESCE(`vehicle_activity`.`interested_events`, 0) AS `interested_events`,\n    COALESCE(`vehicle_activity`.`buy_now_events`, 0) AS `buy_now_events`,\n    COALESCE(`vehicle_activity`.`buy_now_confirmation_events`, 0)\n        AS `buy_now_confirmation_events`,\n    COALESCE(`vehicle_activity`.`showroom_events`, 0) AS `showroom_events`,\n    COALESCE(`vehicle_requests`.`opened_requests`, 0) AS `opened_requests`,\n    COALESCE(`vehicle_requests`.`successful_requests`, 0) AS `successful_requests`,\n    COALESCE(`vehicle_requests`.`opened_salesforce_opportunities`, 0)\n        AS `opened_salesforce_opportunities`,\n    COALESCE(`vehicle_requests`.`successful_salesforce_opportunities`, 0)\n        AS `successful_salesforce_opportunities`\nFROM `pricing-338819`.`ajans_db`.`vehicles` AS `aj_vehicle`\nLEFT JOIN `pricing-338819`.`reporting`.`vehicle_acquisition_to_selling` AS `sf_vehicle`\n    ON `aj_vehicle`.`sf_vehicle_id` = `sf_vehicle`.`car_id`\nCROSS JOIN `dates` AS `d`\nLEFT JOIN `vehicle_activity` AS `vehicle_activity`\n    ON\n        `aj_vehicle`.`id` = `vehicle_activity`.`vehicle_id`\n        AND `d`.`date_key` = `vehicle_activity`.`date_key`\nLEFT JOIN `vehicle_requests` AS `vehicle_requests`\n    ON\n        `aj_vehicle`.`id` = `vehicle_requests`.`vehicle_id`\n        AND `d`.`date_key` = `vehicle_activity`.`date_key`\nLEFT JOIN `all_sessions`\n    ON `d`.`date_key` = `all_sessions`.`date_key`\nWHERE\n    `d`.`date_key` >= DATE(`aj_vehicle`.`created_at`)\n    AND (\n        `vehicle_activity`.`car_profile_events` > 0\n        OR `vehicle_requests`.`opened_requests` > 0\n    )", "relation_name": "`pricing-338819`.`dealers_activity`.`vehicle_activity`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-02-12T13:17:10.976407Z", "completed_at": "2024-02-12T13:17:10.979917Z"}, {"name": "execute", "started_at": "2024-02-12T13:17:10.980423Z", "completed_at": "2024-02-12T13:17:10.980427Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.005026102066040039, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.dealers_activity.dealers", "compiled": true, "compiled_code": "with __dbt__cte__stg_dealers as (\n\n\nWITH `dealer_first_visit` AS (\n    SELECT\n        `users`.`id` AS `dealer_id`,\n        MIN(`ajans_sessions`.`event_date`) AS `dealer_first_app_visit`\n    FROM `pricing-338819`.`ajans_db`.`users` AS `users`\n    INNER JOIN `pricing-338819`.`mixpanel_processed`.`ajans_mp_users` AS `ajans_mp_users`\n        ON\n            LTRIM(\n        REGEXP_REPLACE(users.phone, r'\\+2|[^0-9|,]', ''),\n        '0'\n    )\n            = LTRIM(\n        REGEXP_REPLACE(ajans_mp_users.mobile_number, r'\\+2|[^0-9|,]', ''),\n        '0'\n    )\n    INNER JOIN\n        `pricing-338819`.`mixpanel_processed`.`ajans_sessions` AS `ajans_sessions`\n        ON `ajans_sessions`.`mp_user_id` IN UNNEST(`ajans_mp_users`.`mp_user_id`)\n    GROUP BY `users`.`id`\n),\n\n`dealer_first_transaction` AS (\n    SELECT\n        `users`.`id` AS `dealer_id`,\n        MIN(CASE\n            WHEN `opportunity`.`opportunity_current_status` IN (\n                \"Documents Review\", \"Customer Handover\", \"Sold\"\n            ) THEN `opportunity`.`opportunity_contract_status_datetime`\n        END)\n            AS `dealer_first_trasaction`\n    FROM `pricing-338819`.`ajans_db`.`users` AS `users`\n    LEFT JOIN\n        `pricing-338819`.`reporting`.`wholesale_selling_opportunity` AS `opportunity`\n        ON `users`.`sf_dealer_id` = `opportunity`.`account_id`\n    WHERE `opportunity`.`opportunity_contract_status_datetime` IS NOT NULL\n    GROUP BY `users`.`id`\n),\n\n`dealer_activation` AS (\n    SELECT\n        `users`.`id` AS `dealer_id`,\n        MIN(`register_applications`.`created_at`) AS `activated_at`\n    FROM `pricing-338819`.`ajans_db`.`register_applications` AS `register_applications`\n    INNER JOIN `pricing-338819`.`ajans_db`.`users` AS `users` USING (`phone`)\n    WHERE `register_applications`.`status` = \"activated\"\n    GROUP BY `users`.`id`\n)\n\nSELECT\n    `users`.`id` AS `dealer_id`,\n    `users`.`sf_dealer_id` AS `sf_dealer_id`,\n    `users`.`name` AS `dealer_name`,\n    `users`.`phone` AS `dealer_phone`,\n    `users`.`created_at` AS `dealer_created_at`,\n    `users`.`email` AS `dealer_email`,\n    `sf_account`.`Area__c` AS `area`,\n    `sf_account`.`City__c` AS `city`,\n    `users`.`first_bid` AS `dealer_first_bid`,\n    `dealers_contacts`.`dealer_type`,\n    `dealer_first_visit`.`dealer_first_app_visit`,\n    COALESCE(\n        `dealer_activation`.`activated_at`,\n        CASE WHEN `users`.`active` THEN `users`.`created_at` END\n    ) AS `activated_at`,\n    `dealer_first_transaction`.`dealer_first_trasaction`\nFROM `pricing-338819`.`ajans_db`.`users` AS `users`\nLEFT JOIN `dealer_first_visit` ON `users`.`id` = `dealer_first_visit`.`dealer_id`\nLEFT JOIN `dealer_first_transaction`\n    ON `users`.`id` = `dealer_first_transaction`.`dealer_id`\nLEFT JOIN `dealer_activation`\n    ON `users`.`id` = `dealer_activation`.`dealer_id`\nLEFT JOIN\n    `pricing-338819`.`ajans_db`.`dealers_contacts` AS `dealers_contacts`\n    ON `users`.`dealer_contact_id` = `dealers_contacts`.`id`\nLEFT JOIN\n    `pricing-338819`.`ajans_db`.`dealer_ships` AS `dealer_ships`\n    ON `dealers_contacts`.`dealer_id` = `dealer_ships`.`id`\nLEFT JOIN\n    `pricing-338819`.`salesforce`.`Account` AS `sf_account`\n    ON `users`.`sf_dealer_id` = `sf_account`.`Id`\nLEFT JOIN `pricing-338819`.`ajans_db`.`users_roles` AS `users_roles`\n    ON `users`.`id` = `users_roles`.`user_id`\nLEFT JOIN `pricing-338819`.`ajans_db`.`roles` AS `roles`\n    ON `users_roles`.`role_id` = `roles`.`id`\n) SELECT\n    `dealers`.*,\n    `segmentation`.`dealer_segment` AS `current_dealer_segment`\nFROM __dbt__cte__stg_dealers AS `dealers`\nLEFT JOIN\n    `pricing-338819`.`dealers_activity`.`dealers_segmentation` AS `segmentation`\n    ON\n        `dealers`.`dealer_id` = `segmentation`.`dealer_id`\n        AND DATE(DATE_TRUNC(CURRENT_DATE(), MONTH)) = `segmentation`.`month_date`", "relation_name": "`pricing-338819`.`dealers_activity`.`dealers`"}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-02-12T13:17:10.981949Z", "completed_at": "2024-02-12T13:17:11.027292Z"}, {"name": "execute", "started_at": "2024-02-12T13:17:11.027776Z", "completed_at": "2024-02-12T13:17:11.027780Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.046813249588012695, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.dealers_activity.dealers_activity", "compiled": true, "compiled_code": "\n\nWITH  __dbt__cte__stg_dealers as (\n\n\nWITH `dealer_first_visit` AS (\n    SELECT\n        `users`.`id` AS `dealer_id`,\n        MIN(`ajans_sessions`.`event_date`) AS `dealer_first_app_visit`\n    FROM `pricing-338819`.`ajans_db`.`users` AS `users`\n    INNER JOIN `pricing-338819`.`mixpanel_processed`.`ajans_mp_users` AS `ajans_mp_users`\n        ON\n            LTRIM(\n        REGEXP_REPLACE(users.phone, r'\\+2|[^0-9|,]', ''),\n        '0'\n    )\n            = LTRIM(\n        REGEXP_REPLACE(ajans_mp_users.mobile_number, r'\\+2|[^0-9|,]', ''),\n        '0'\n    )\n    INNER JOIN\n        `pricing-338819`.`mixpanel_processed`.`ajans_sessions` AS `ajans_sessions`\n        ON `ajans_sessions`.`mp_user_id` IN UNNEST(`ajans_mp_users`.`mp_user_id`)\n    GROUP BY `users`.`id`\n),\n\n`dealer_first_transaction` AS (\n    SELECT\n        `users`.`id` AS `dealer_id`,\n        MIN(CASE\n            WHEN `opportunity`.`opportunity_current_status` IN (\n                \"Documents Review\", \"Customer Handover\", \"Sold\"\n            ) THEN `opportunity`.`opportunity_contract_status_datetime`\n        END)\n            AS `dealer_first_trasaction`\n    FROM `pricing-338819`.`ajans_db`.`users` AS `users`\n    LEFT JOIN\n        `pricing-338819`.`reporting`.`wholesale_selling_opportunity` AS `opportunity`\n        ON `users`.`sf_dealer_id` = `opportunity`.`account_id`\n    WHERE `opportunity`.`opportunity_contract_status_datetime` IS NOT NULL\n    GROUP BY `users`.`id`\n),\n\n`dealer_activation` AS (\n    SELECT\n        `users`.`id` AS `dealer_id`,\n        MIN(`register_applications`.`created_at`) AS `activated_at`\n    FROM `pricing-338819`.`ajans_db`.`register_applications` AS `register_applications`\n    INNER JOIN `pricing-338819`.`ajans_db`.`users` AS `users` USING (`phone`)\n    WHERE `register_applications`.`status` = \"activated\"\n    GROUP BY `users`.`id`\n)\n\nSELECT\n    `users`.`id` AS `dealer_id`,\n    `users`.`sf_dealer_id` AS `sf_dealer_id`,\n    `users`.`name` AS `dealer_name`,\n    `users`.`phone` AS `dealer_phone`,\n    `users`.`created_at` AS `dealer_created_at`,\n    `users`.`email` AS `dealer_email`,\n    `sf_account`.`Area__c` AS `area`,\n    `sf_account`.`City__c` AS `city`,\n    `users`.`first_bid` AS `dealer_first_bid`,\n    `dealers_contacts`.`dealer_type`,\n    `dealer_first_visit`.`dealer_first_app_visit`,\n    COALESCE(\n        `dealer_activation`.`activated_at`,\n        CASE WHEN `users`.`active` THEN `users`.`created_at` END\n    ) AS `activated_at`,\n    `dealer_first_transaction`.`dealer_first_trasaction`\nFROM `pricing-338819`.`ajans_db`.`users` AS `users`\nLEFT JOIN `dealer_first_visit` ON `users`.`id` = `dealer_first_visit`.`dealer_id`\nLEFT JOIN `dealer_first_transaction`\n    ON `users`.`id` = `dealer_first_transaction`.`dealer_id`\nLEFT JOIN `dealer_activation`\n    ON `users`.`id` = `dealer_activation`.`dealer_id`\nLEFT JOIN\n    `pricing-338819`.`ajans_db`.`dealers_contacts` AS `dealers_contacts`\n    ON `users`.`dealer_contact_id` = `dealers_contacts`.`id`\nLEFT JOIN\n    `pricing-338819`.`ajans_db`.`dealer_ships` AS `dealer_ships`\n    ON `dealers_contacts`.`dealer_id` = `dealer_ships`.`id`\nLEFT JOIN\n    `pricing-338819`.`salesforce`.`Account` AS `sf_account`\n    ON `users`.`sf_dealer_id` = `sf_account`.`Id`\nLEFT JOIN `pricing-338819`.`ajans_db`.`users_roles` AS `users_roles`\n    ON `users`.`id` = `users_roles`.`user_id`\nLEFT JOIN `pricing-338819`.`ajans_db`.`roles` AS `roles`\n    ON `users_roles`.`role_id` = `roles`.`id`\n),  __dbt__cte__stg_opportunity_request as (\n\n\nWITH `opportunity_request` AS (\n    SELECT DISTINCT\n        `auction_requests`.`id` AS `request_id`,\n        `opportunity`.`opportunity_id` AS `opportunity_id`,\n        `opportunity`.`opportunity_current_status` AS `opportunity_stage_name`,\n        `opportunity`.`opportunity_creation_datetime`,\n        `opportunity`.`opportunity_close_date`,\n        `opportunity`.`opportunity_log_payment_status_datetime`,\n        `opportunity`.`opportunity_payment_status_datetime`,\n        `opportunity`.`opportunity_contract_status_datetime`,\n        `opportunity`.`opportunity_customer_handover_status_datetime`,\n        `opportunity`.`opportunity_sold_status_datetime`,\n        `opportunity`.`opportunity_returned_status_datetime`,\n        `opportunity`.`is_sold` AS `opportunity_is_sold`,\n        `opportunity`.`is_returned` AS `opportunity_is_returned`,\n        `opportunity`.`is_tbi` AS `opportunity_is_tbi`,\n        `opportunity`.`is_tbi_in_progress` AS `opportunity_is_tbi_in_progress`,\n        `opportunity`.`is_delivered` AS `opportunity_is_delivered`,\n        ROW_NUMBER()\n            OVER (\n                PARTITION BY `opportunity`.`opportunity_id`\n                ORDER BY\n                    DATE_DIFF(\n                        `opportunity`.`opportunity_creation_datetime`,\n                        `auction_requests`.`created_at`,\n                        SECOND\n                    ) ASC\n            )\n            AS `recency_rank`\n    FROM\n        `pricing-338819`.`ajans_db`.`auction_requests` AS `auction_requests`\n    INNER JOIN\n        `pricing-338819`.`ajans_db`.`users` AS `users`\n        ON\n            `auction_requests`.`dealer_id` = `users`.`id`\n    INNER JOIN\n        `pricing-338819`.`ajans_db`.`vehicle_auctions` AS `vehicle_auctions`\n        ON\n            `auction_requests`.`auction_id` = `vehicle_auctions`.`id`\n    INNER JOIN\n        `pricing-338819`.`ajans_db`.`vehicles` AS `vehicles`\n        ON\n            `vehicle_auctions`.`vehicle_id` = `vehicles`.`id`\n    INNER JOIN\n        `pricing-338819`.`salesforce`.`Car__c` AS `car`\n        ON\n            `vehicles`.`sf_vehicle_id` = `car`.`id`\n    INNER JOIN\n        `pricing-338819`.`reporting`.`wholesale_selling_opportunity` AS `opportunity`\n        ON\n            `users`.`sf_dealer_id` = `opportunity`.`account_id`\n            AND `car`.`Id` = `opportunity`.`car_id`\n    WHERE\n        DATE_DIFF(\n            `opportunity`.`opportunity_creation_datetime`,\n            `auction_requests`.`created_at`,\n            SECOND\n        )\n        >= 0\n        AND `auction_requests`.`type` = 'Buy Now'\n)\n\nSELECT *\nFROM `opportunity_request`\nWHERE `recency_rank` = 1\n), `dates` AS (\n    SELECT `date_array` AS `date_key`\n    FROM\n        UNNEST(\n            GENERATE_DATE_ARRAY(\"2022-02-01\", CURRENT_DATE(), INTERVAL 1 DAY)\n        ) AS `date_array`\n    \n        WHERE `date_array` >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n    \n),\n\n`all_cars_events` AS (\n    SELECT\n        `aj_screen_all_auctions`.`event_date` AS `date_key`,\n        `aj_mp_users`.`mobile_number`,\n        COUNT(DISTINCT `aj_screen_all_auctions`.`mp_event_id`) AS `all_cars_events`\n    FROM\n        `pricing-338819`.`mixpanel_processed`.`ajans_screen_all_auctions`\n            AS `aj_screen_all_auctions`\n    LEFT JOIN `pricing-338819`.`mixpanel_processed`.`ajans_mp_users` AS `aj_mp_users`\n        ON\n            `aj_screen_all_auctions`.`mp_user_id` IN UNNEST(`aj_mp_users`.`mp_user_id`)\n    \n        WHERE\n            `aj_screen_all_auctions`.`event_date`\n            >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n    \n    GROUP BY `aj_screen_all_auctions`.`event_date`, `aj_mp_users`.`mobile_number`\n),\n\n`car_profile_events` AS (\n    SELECT\n        `aj_screen_auction_profile`.`event_date` AS `date_key`,\n        `aj_mp_users`.`mobile_number`,\n        COUNT(DISTINCT `aj_screen_auction_profile`.`mp_event_id`)\n            AS `car_profile_events`\n    FROM\n        `pricing-338819`.`mixpanel_processed`.`ajans_screen_auction_profile`\n            AS `aj_screen_auction_profile`\n    LEFT JOIN `pricing-338819`.`mixpanel_processed`.`ajans_mp_users` AS `aj_mp_users`\n        ON\n            `aj_screen_auction_profile`.`mp_user_id` IN UNNEST(\n                `aj_mp_users`.`mp_user_id`\n            )\n    \n        WHERE\n            `aj_screen_auction_profile`.`event_date`\n            >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n    \n    GROUP BY `aj_screen_auction_profile`.`event_date`, `aj_mp_users`.`mobile_number`\n),\n\n`interested_events` AS (\n    SELECT\n        `aj_action_interested`.`event_date` AS `date_key`,\n        `aj_mp_users`.`mobile_number`,\n        COUNT(DISTINCT `aj_action_interested`.`mp_event_id`) AS `interested_events`\n    FROM\n        `pricing-338819`.`mixpanel_processed`.`ajans_action_interested`\n            AS `aj_action_interested`\n    LEFT JOIN `pricing-338819`.`mixpanel_processed`.`ajans_mp_users` AS `aj_mp_users`\n        ON\n            `aj_action_interested`.`mp_user_id` IN UNNEST(`aj_mp_users`.`mp_user_id`)\n    \n        WHERE\n            `aj_action_interested`.`event_date`\n            >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n    \n    GROUP BY `aj_action_interested`.`event_date`, `aj_mp_users`.`mobile_number`\n),\n\n`buy_now_events` AS (\n    SELECT\n        `aj_action_buy_now`.`event_date` AS `date_key`,\n        `aj_mp_users`.`mobile_number`,\n        COUNT(DISTINCT `aj_action_buy_now`.`mp_event_id`) AS `buy_now_events`\n    FROM\n        `pricing-338819`.`mixpanel_processed`.`ajans_action_buy_now`\n            AS `aj_action_buy_now`\n    LEFT JOIN `pricing-338819`.`mixpanel_processed`.`ajans_mp_users` AS `aj_mp_users`\n        ON\n            `aj_action_buy_now`.`mp_user_id` IN UNNEST(`aj_mp_users`.`mp_user_id`)\n    \n        WHERE\n            `aj_action_buy_now`.`event_date`\n            >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n    \n    GROUP BY `aj_action_buy_now`.`event_date`, `aj_mp_users`.`mobile_number`\n),\n\n`buy_now_confirmation_events` AS (\n    SELECT\n        `aj_screen_buy_now_confirmation_popup`.`event_date` AS `date_key`,\n        `aj_mp_users`.`mobile_number`,\n        COUNT(DISTINCT `aj_screen_buy_now_confirmation_popup`.`mp_event_id`)\n            AS `buy_now_confirmation_events`\n    FROM\n        `pricing-338819`.`mixpanel_processed`.`ajans_screen_buy_now_confirmation_popup`\n            AS `aj_screen_buy_now_confirmation_popup`\n    LEFT JOIN `pricing-338819`.`mixpanel_processed`.`ajans_mp_users` AS `aj_mp_users`\n        ON\n            `aj_screen_buy_now_confirmation_popup`.`mp_user_id` IN UNNEST(\n                `aj_mp_users`.`mp_user_id`\n            )\n    \n        WHERE\n            `aj_screen_buy_now_confirmation_popup`.`event_date`\n            >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n    \n    GROUP BY\n        `aj_screen_buy_now_confirmation_popup`.`event_date`,\n        `aj_mp_users`.`mobile_number`\n),\n\n`aj_action_showroom_request` AS (\n    SELECT\n        `aj_action_showroom_request`.`event_date` AS `date_key`,\n        `aj_mp_users`.`mobile_number`,\n        COUNT(DISTINCT `aj_action_showroom_request`.`event_id`) AS `showroom_events`\n    FROM\n        `pricing-338819`.`mixpanel_processed`.`ajans_action_showroom_request`\n            AS `aj_action_showroom_request`\n    LEFT JOIN `pricing-338819`.`mixpanel_processed`.`ajans_mp_users` AS `aj_mp_users`\n        ON\n            `aj_action_showroom_request`.`mp_user_id` IN UNNEST(\n                `aj_mp_users`.`mp_user_id`\n            )\n    \n        WHERE\n            `aj_action_showroom_request`.`event_date`\n            >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n    \n    GROUP BY `aj_action_showroom_request`.`event_date`, `aj_mp_users`.`mobile_number`\n),\n\n`all_sessions` AS (\n    SELECT\n        `aj_sessions`.`event_date` AS `date_key`,\n        `aj_mp_users`.`mobile_number`,\n        COUNT(DISTINCT `aj_sessions`.`mp_session_id`) AS `all_sessions`\n    FROM `pricing-338819`.`mixpanel_processed`.`ajans_sessions` AS `aj_sessions`\n    LEFT JOIN `pricing-338819`.`mixpanel_processed`.`ajans_mp_users` AS `aj_mp_users`\n        ON\n            `aj_sessions`.`mp_user_id` IN UNNEST(`aj_mp_users`.`mp_user_id`)\n    \n        WHERE `aj_sessions`.`event_date` >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)\n    \n    GROUP BY `aj_sessions`.`event_date`, `aj_mp_users`.`mobile_number`\n)\n\n\nSELECT\n    `d`.`date_key` AS `event_date`,\n    `dealers`.`dealer_id`,\n    `dealers`.`sf_dealer_id`,\n    `dealers`.`dealer_name`,\n    `dealers`.`dealer_phone`,\n    `dealers`.`dealer_created_at`,\n    `dealers`.`dealer_email`,\n    `dealers`.`area`,\n    `dealers`.`city`,\n    `dealers`.`dealer_first_bid`,\n    `dealers`.`dealer_type`,\n    `dealers`.`dealer_first_app_visit`,\n    `dealers`.`dealer_first_trasaction`,\n    `dealers`.`activated_at`,\n    `segmentation`.`dealer_segment` AS `current_dealer_segment`,\n    COALESCE(ANY_VALUE(`all_sessions`.`all_sessions`), 0) AS `all_sessions`,\n    COALESCE(ANY_VALUE(`all_cars_events`.`all_cars_events`), 0) AS `all_cars_events`,\n    COALESCE(ANY_VALUE(`car_profile_events`.`car_profile_events`), 0)\n        AS `car_profile_events`,\n    COALESCE(ANY_VALUE(`interested_events`.`interested_events`), 0)\n        AS `interested_events`,\n    COALESCE(ANY_VALUE(`buy_now_events`.`buy_now_events`), 0) AS `buy_now_events`,\n    COALESCE(ANY_VALUE(`buy_now_confirmation_events`.`buy_now_confirmation_events`), 0)\n        AS `buy_now_confirmation_events`,\n    COALESCE(ANY_VALUE(`aj_action_showroom_request`.`showroom_events`), 0)\n        AS `showroom_events`,\n    COUNT(DISTINCT `dealers_requests`.`id`) AS `opened_requests`,\n    COALESCE(COUNT(\n        DISTINCT CASE\n            WHEN `arl`.`auction_request_status` = \"Succeeded\"\n                THEN `dealers_requests`.`id`\n        END\n    ), 0) AS `successful_requests`,\n    COALESCE(COUNT(DISTINCT `ro`.`opportunity_id`), 0)\n        AS `opened_salesforce_opportunities`,\n    COALESCE(COUNT(\n        DISTINCT CASE\n            WHEN `ro`.`opportunity_stage_name` = \"Sold\" THEN `ro`.`opportunity_id`\n        END\n    ), 0) AS `successful_salesforce_opportunities`\nFROM __dbt__cte__stg_dealers AS `dealers`\nLEFT JOIN\n    `pricing-338819`.`dealers_activity`.`dealers_segmentation` AS `segmentation`\n    ON\n        `dealers`.`dealer_id` = `segmentation`.`dealer_id`\n        AND DATE(DATE_TRUNC(CURRENT_DATE(), MONTH)) = `segmentation`.`month_date`\nCROSS JOIN `dates` AS `d`\nLEFT JOIN\n    `pricing-338819`.`mixpanel_processed`.`ajans_mp_users` AS `aj_mp_users`\n    ON\n        LTRIM(\n        REGEXP_REPLACE(dealers.dealer_phone, r'\\+2|[^0-9|,]', ''),\n        '0'\n    )\n        = LTRIM(\n        REGEXP_REPLACE(aj_mp_users.mobile_number, r'\\+2|[^0-9|,]', ''),\n        '0'\n    )\nLEFT JOIN `pricing-338819`.`ajans_db`.`auction_requests` AS `dealers_requests`\n    ON\n        `dealers`.`dealer_id` = `dealers_requests`.`dealer_id`\n        AND DATE(`dealers_requests`.`created_at`) = `d`.`date_key`\nLEFT JOIN `all_cars_events` USING (`mobile_number`, `date_key`)\nLEFT JOIN `car_profile_events` USING (`mobile_number`, `date_key`)\nLEFT JOIN `interested_events` USING (`mobile_number`, `date_key`)\nLEFT JOIN `buy_now_events` USING (`mobile_number`, `date_key`)\nLEFT JOIN `buy_now_confirmation_events` USING (`mobile_number`, `date_key`)\nLEFT JOIN `aj_action_showroom_request` USING (`mobile_number`, `date_key`)\nLEFT JOIN `all_sessions` USING (`mobile_number`, `date_key`)\nLEFT JOIN\n    `pricing-338819`.`ajans_db`.`auction_request_logs` AS `arl`\n    ON `dealers_requests`.`id` = `arl`.`auction_request_id`\nLEFT JOIN\n    __dbt__cte__stg_opportunity_request AS `ro`\n    ON `dealers_requests`.`id` = `ro`.`request_id`\nWHERE\n    `d`.`date_key` >= DATE(`dealers`.`dealer_created_at`)\n    AND LOWER(`dealers`.`dealer_email`) NOT LIKE \"%sylndr%\"\nGROUP BY\n    `dealers`.`dealer_id`,\n    `dealers`.`sf_dealer_id`,\n    `d`.`date_key`,\n    `dealers`.`dealer_name`,\n    `dealers`.`dealer_phone`,\n    `dealers`.`dealer_created_at`,\n    `dealers`.`dealer_email`,\n    `dealers`.`area`,\n    `dealers`.`city`,\n    `dealers`.`dealer_first_bid`,\n    `dealers`.`dealer_type`,\n    `dealers`.`dealer_first_app_visit`,\n    `dealers`.`dealer_first_trasaction`,\n    `dealers`.`activated_at`,\n    `segmentation`.`dealer_segment`\nHAVING `all_cars_events` > 0 OR `all_sessions` > 0 OR `opened_requests` > 0", "relation_name": "`pricing-338819`.`dealers_activity`.`dealers_activity`"}], "elapsed_time": 1.000756025314331, "args": {"partial_parse_file_diff": true, "static_parser": true, "populate_cache": true, "empty_catalog": false, "log_file_max_bytes": 10485760, "printer_width": 80, "log_format": "default", "warn_error_options": {"include": [], "exclude": []}, "enable_legacy_logger": false, "use_colors": true, "partial_parse": true, "write_json": true, "compile": true, "exclude": [], "introspect": true, "show_resource_report": false, "quiet": false, "vars": {}, "log_level": "info", "which": "generate", "log_path": "/Users/user/Documents/Sylndr/airflow-dags/dags/src/dbt/dealers_activity/logs", "send_anonymous_usage_stats": true, "profiles_dir": "/Users/user/Documents/Sylndr/airflow-dags/dags/src/dbt/dealers_activity", "log_level_file": "debug", "defer": false, "invocation_command": "dbt docs generate", "strict_mode": false, "static": false, "version_check": true, "select": [], "indirect_selection": "eager", "use_colors_file": true, "favor_state": false, "cache_selected_only": false, "print": true, "macro_debugging": false, "project_dir": "/Users/user/Documents/Sylndr/airflow-dags/dags/src/dbt/dealers_activity", "log_format_file": "debug"}}